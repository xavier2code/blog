<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://xavier2code.site name=base><title>
            
                Understanding proc_macro_attribute in Rust
            
        </title><meta content="Understanding proc_macro_attribute in Rust" property=og:title><link href=https://xavier2code.site/favicon.png rel=icon type=image/png><link href=https://xavier2code.site/fonts.css rel=stylesheet><script async data-goatcounter=https://xavier2code.goatcounter.com/count src=https://xavier2code.site/js/count.js></script><noscript><img src="https://xavier2code.goatcounter.com//count?p=/posts/rust6/&t=Understanding proc_macro_attribute in Rust"></noscript><script defer src=https://xavier2code.site/js/codeblock.js></script><script src=https://xavier2code.site/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link href=https://xavier2code.site/atom.xml rel=alternate title=xavier2code type=application/atom+xml><link href=https://xavier2code.site/theme/light.css rel=stylesheet><link href=https://xavier2code.site/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://xavier2code.site/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://xavier2code.site/main.css media=screen rel=stylesheet><script src="https://xavier2code.site/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=left-content></div><div class=content><nav><div class=left-nav><a href=https://xavier2code.site>xavier2code</a><div class=socials><a class=social href=https://mail.google.com/ rel=me> <img alt=email src=https://xavier2code.site/icons/social/email.svg> </a><a class=social href=https://github.com/xavier2code/ rel=me> <img alt=github src=https://xavier2code.site/icons/social/github.svg> </a><a class=social href=https://discord.com/ rel=me> <img alt=discord src=https://xavier2code.site/icons/social/discord.svg> </a><a class=social href=https://www.reddit.com/ rel=me> <img alt=reddit src=https://xavier2code.site/icons/social/reddit.svg> </a><a class=social href=https://x.com/ rel=me> <img alt=x-twitter src=https://xavier2code.site/icons/social/x-twitter.svg> </a></div></div><div class=right-nav><a href=https://xavier2code.site/posts style=margin-right:.5em>/posts</a><a href=https://xavier2code.site/projects style=margin-right:.5em>/projects</a><a href=https://xavier2code.site/archive style=margin-right:.5em>/archive</a><a href=https://xavier2code.site/about style=margin-right:.5em>/about</a><a href=https://xavier2code.site/tags style=margin-right:.5em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://xavier2code.site/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://xavier2code.site/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://xavier2code.site/icons/moon.svg> </a><script>updateItemToggleTheme()</script></div></nav><div data-selector="main article p" class=visible-element-observer-root><main><article><div class=title><div class=page-header>Understanding proc_macro_attribute in Rust</div><div class=meta>Posted on <time>2025-02-08</time><span class=tags-label> :: </span><span class=tags> <a class=post-tag href=https://xavier2code.site/tags/documentation/>documentation</a> <a class=post-tag href=https://xavier2code.site/tags/rust/>rust</a> </span></div></div><section class=body><p><code>proc_macro_attribute</code> is a type of procedural macro in Rust that allows you to define custom attributes. These attributes can be attached to items like functions, structs, enums, and more. The macro can then manipulate or generate code based on the item it is attached to.<h2 id=key-concepts><a aria-label="Anchor link for: key-concepts" class=zola-anchor href=#key-concepts>Key Concepts</a></h2><ol><li>Procedural Macros:</ol><ul><li>Procedural macros are unhygienic, meaning they behave as if the output token stream was written inline to the code itâ€™s next to.<li>They can be function-like, derive, or attribute macros.</ul><ol start=2><li>Attribute Macros:</ol><ul><li>Attribute macros define new outer attributes that can be attached to items.<li>They are defined by a public function with the <code>proc_macro_attribute</code> attribute and a signature of ``(TokenStream, TokenStream) -> TokenStream`.</ul><h2 id=example-of-proc-macro-attribute><a aria-label="Anchor link for: example-of-proc-macro-attribute" class=zola-anchor href=#example-of-proc-macro-attribute>Example of <code>proc_macro_attribute</code></a></h2><p>Let's create a custom attribute macro that logs the input and output token streams.<ol><li>Create a new procedural macro crate:</ol><pre class=language-sh data-lang=sh style=color:#61676c;background-color:#fafafa><code class=language-sh data-lang=sh><span style=color:#f29718>cargo</span><span> new my_macro</span><span style=color:#ff8f40> --lib
</span><span style=color:#f07171>cd</span><span> my_macro
</span></code></pre><ol start=2><li>Modify <code>Cargo.toml</code>:</ol><pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span>[</span><span style=color:#399ee6>lib</span><span>]
</span><span style=color:#399ee6>proc-macro </span><span>= </span><span style=color:#ff8f40>true
</span><span>
</span><span>[</span><span style=color:#399ee6>dependencies</span><span>]
</span><span style=color:#399ee6>proc-macro2 </span><span>= </span><span style=color:#86b300>"1.0"
</span><span style=color:#399ee6>quote </span><span>= </span><span style=color:#86b300>"1.0"
</span><span style=color:#399ee6>syn </span><span>= </span><span style=color:#86b300>"1.0"
</span></code></pre><ol start=3><li>Implement the attribute macro in <code>src/lib.rs</code>:</ol><pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>extern crate</span><span> proc_macro</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>use </span><span>proc_macro</span><span style=color:#ed9366>::</span><span>TokenStream</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>use </span><span>quote</span><span style=color:#ed9366>::</span><span>quote</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>use </span><span>syn</span><span style=color:#ed9366>::</span><span>{parse_macro_input</span><span style=color:#61676ccc>,</span><span> ItemFn}</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#ed9366># </span><span>[proc_macro_attribute]
</span><span style=color:#fa6e32>pub fn </span><span style=color:#f29718>log_streams</span><span>(</span><span style=color:#ff8f40>attr</span><span style=color:#61676ccc>:</span><span> TokenStream, </span><span style=color:#ff8f40>item</span><span style=color:#61676ccc>:</span><span> TokenStream) </span><span style=color:#61676ccc>-></span><span> TokenStream {
</span><span style=color:#abb0b6;font-style:italic>// Parse the input token stream as a function item
</span><span style=color:#fa6e32>let</span><span> input_fn </span><span style=color:#ed9366>= </span><span style=color:#f07171>parse_macro_input!</span><span>(item </span><span style=color:#ed9366>as</span><span> ItemFn)</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Convert the function item back to a token stream for logging
</span><span>    </span><span style=color:#fa6e32>let</span><span> item_str </span><span style=color:#ed9366>=</span><span> item</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_string</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>let</span><span> attr_str </span><span style=color:#ed9366>=</span><span> attr</span><span style=color:#ed9366>.</span><span style=color:#f07171>to_string</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Log the input streams
</span><span>    </span><span style=color:#f07171>println!</span><span>(</span><span style=color:#86b300>"Attribute: </span><span style=color:#ff8f40>{}</span><span style=color:#86b300>"</span><span style=color:#61676ccc>,</span><span> attr_str)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f07171>println!</span><span>(</span><span style=color:#86b300>"Item: </span><span style=color:#ff8f40>{}</span><span style=color:#86b300>"</span><span style=color:#61676ccc>,</span><span> item_str)</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Generate the output token stream
</span><span>    </span><span style=color:#fa6e32>let</span><span> expanded </span><span style=color:#ed9366>= </span><span style=color:#f07171>quote! </span><span>{
</span><span>        </span><span style=color:#ed9366>#</span><span>input_fn
</span><span>    }</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// Return the generated token stream
</span><span>    TokenStream</span><span style=color:#ed9366>::</span><span>from(expanded)
</span><span>
</span><span>}
</span></code></pre><ol start=4><li>Use the attribute macro in another crate:</ol><pre class=language-sh data-lang=sh style=color:#61676c;background-color:#fafafa><code class=language-sh data-lang=sh><span style=color:#f29718>cargo</span><span> new my_project
</span><span style=color:#f07171>cd</span><span> my_project
</span></code></pre><p>Modify <code>Cargo.toml</code> to include the macro crate as a dependency:<pre class=language-toml data-lang=toml style=color:#61676c;background-color:#fafafa><code class=language-toml data-lang=toml><span>[</span><span style=color:#399ee6>dependencies</span><span>]
</span><span style=color:#399ee6>my_macro </span><span>= { </span><span style=color:#399ee6>path </span><span>= </span><span style=color:#86b300>"../my_macro" </span><span>}
</span></code></pre><p>Use the attribute macro in <code>src/main.rs</code>:<pre class=language-rust data-lang=rust style=color:#61676c;background-color:#fafafa><code class=language-rust data-lang=rust><span style=color:#fa6e32>extern crate</span><span> my_macro</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>use </span><span>my_macro</span><span style=color:#ed9366>::</span><span>log_streams</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#ed9366># </span><span>[log_streams]
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>my_function</span><span>() {
</span><span>  </span><span style=color:#f07171>println!</span><span>(</span><span style=color:#86b300>"Hello, world!"</span><span>)</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#fa6e32>fn </span><span style=color:#f29718>main</span><span>() {
</span><span>  </span><span style=color:#f07171>my_function</span><span>()</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>When you run this code, the <code>log_streams</code> macro will log the input attribute and item token streams to the console.<h2 id=explanation><a aria-label="Anchor link for: explanation" class=zola-anchor href=#explanation>Explanation</a></h2><ul><li>Input Token Streams: <ul><li>The first <code>TokenStream</code> (<code>attr</code>) contains the tokens following the attribute name.<li>The second <code>TokenStream</code> (<code>item</code>) contains the tokens of the item the attribute is attached to.</ul><li>Output Token Stream: <ul><li>The macro generates a new <code>TokenStream</code> that replaces the original item. In this example, it simply returns the original item unchanged.</ul><li>Use Case: <ul><li>This example logs the token streams for debugging purposes. In a real-world scenario, you might generate additional code or modify the item based on the attribute.</ul></ul><h2 id=summary><a aria-label="Anchor link for: summary" class=zola-anchor href=#summary>Summary</a></h2><p><code>proc_macro_attribute</code> allows you to define custom attributes that can manipulate or generate code based on the items they are attached to. By using procedural macros, you can create powerful tools for code generation and manipulation at compile time.</section></article></main></div><div class=giscus></div><script async crossorigin issue-term=pathname label=Comment repo=xavier2code/blog src=https://utteranc.es/client.js theme=preferred-color-scheme></script></div><div class=right-content></div>